const anketler = {
  cevrecimisiniz: {
    baslik: "Ne kadar Ã§evrecisiniz?",
    sorular: [
      "Geri dÃ¶nÃ¼ÅŸÃ¼m kutularÄ±nÄ± dÃ¼zenli kullanÄ±r mÄ±sÄ±nÄ±z?",
      "Plastik poÅŸet yerine bez Ã§anta kullanÄ±r mÄ±sÄ±nÄ±z?",
      "KullanmadÄ±ÄŸÄ±nÄ±z elektronik cihazlarÄ± fiÅŸten Ã§eker misiniz?",
      "Suyu gereksiz yere aÃ§Ä±k bÄ±rakmaz mÄ±sÄ±nÄ±z?",
      "Toplu taÅŸÄ±ma araÃ§larÄ±nÄ± tercih eder misiniz?",
      "KaÄŸÄ±t israfÄ±nÄ± Ã¶nlemeye dikkat eder misiniz?",
      "Evde enerji tasarrufu yapar mÄ±sÄ±nÄ±z?",
      "DoÄŸaya Ã§Ã¶p atmaz mÄ±sÄ±nÄ±z?",
      "Ã‡evreyle ilgili kampanyalara katÄ±lÄ±r mÄ±sÄ±nÄ±z?",
      "AÄŸaÃ§ dikme etkinliklerine katÄ±lÄ±r mÄ±sÄ±nÄ±z?"
    ]
  },
  hayvansever: {
    baslik: "Patili dostlara bakÄ±ÅŸÄ±mÄ±z",
    sorular: [
      "Evcil hayvan sahiplenmeyi dÃ¼ÅŸÃ¼nÃ¼yor musunuz?",
      "Sokak hayvanlarÄ±na mama ve su verir misiniz?",
      "Hayvan barÄ±naklarÄ±na destek olmayÄ± dÃ¼ÅŸÃ¼nÃ¼yor musunuz?",
      "HayvanlarÄ±n haklarÄ±na saygÄ± gÃ¶sterir misiniz?",
      "Kedi ve kÃ¶peklerin bakÄ±mÄ±nÄ± dÃ¼zenli yapar mÄ±sÄ±nÄ±z?",
      "Hayvanlara zarar verecek davranÄ±ÅŸlardan kaÃ§Ä±nÄ±r mÄ±sÄ±nÄ±z?",
      "Hayvanlarla ilgili eÄŸitim ve kampanyalarÄ± takip eder misiniz?",
      "Evcil hayvanÄ±nÄ±zÄ± aÅŸÄ± ve saÄŸlÄ±k kontrollerine gÃ¶tÃ¼rÃ¼r mÃ¼sÃ¼nÃ¼z?",
      "Hayvanlar iÃ§in gÃ¶nÃ¼llÃ¼ faaliyetlere katÄ±lÄ±r mÄ±sÄ±nÄ±z?",
      "Hayvanlara karÅŸÄ± duyarlÄ± bir Ã§evreyi destekler misiniz?"
    ]
  },
   topraginsesi: {
    baslik: "TopraÄŸÄ±n Sesi",
    sorular: [
      "MusluklarÄ± aÃ§Ä±k bÄ±rakmadan diÅŸlerinizi fÄ±rÃ§alar mÄ±sÄ±nÄ±z?",
      "DuÅŸ sÃ¼resini 5 dakikadan uzun tutar mÄ±sÄ±nÄ±z?",
      "BahÃ§e sulamasÄ±nÄ± sabah/akÅŸam yapar mÄ±sÄ±nÄ±z?",
      "Evde su tasarruflu musluk baÅŸlÄ±klarÄ± kullanÄ±r mÄ±sÄ±nÄ±z?",
      "BulaÅŸÄ±klarÄ± elde yÄ±kamak yerine bulaÅŸÄ±k makinesi kullanÄ±r mÄ±sÄ±nÄ±z?",
      "Ã‡amaÅŸÄ±rlarÄ± tam dolmadan Ã§alÄ±ÅŸtÄ±rÄ±r mÄ±sÄ±nÄ±z?",
      "YaÄŸmur suyunu bahÃ§e sulamada kullanÄ±r mÄ±sÄ±nÄ±z?",
      "Gereksiz su kullanÄ±mÄ±nÄ± azaltmak iÃ§in dikkat eder misiniz?",
      "Toprak ve bitkiler iÃ§in gereksiz su harcar mÄ±sÄ±nÄ±z?",
      "Su kaynaklarÄ±nÄ± korumak iÃ§in farkÄ±ndalÄ±k yaratÄ±r mÄ±sÄ±nÄ±z?"
    ]
  },
   minimalAtik: {
    baslik: "Minimal AtÄ±k, Maximum Etki",
    sorular: [
      "Evde geri dÃ¶nÃ¼ÅŸÃ¼m kutularÄ±nÄ± kullanÄ±yor musunuz?",
      "KaÄŸÄ±t, plastik ve camlarÄ± ayrÄ± topluyor musunuz?",
      "Tek kullanÄ±mlÄ±k Ã¼rÃ¼nlerden mÃ¼mkÃ¼n olduÄŸunca kaÃ§Ä±nÄ±yor musunuz?",
      "AlÄ±ÅŸveriÅŸlerde ambalajsÄ±z Ã¼rÃ¼nleri tercih ediyor musunuz?",
      "ArtÄ±klarÄ± kompost yapÄ±yor veya organik atÄ±klarÄ± deÄŸerlendiriyor musunuz?",
      "Gereksiz paketlemeyi azaltmak iÃ§in dikkat ediyor musunuz?",
      "SÄ±fÄ±r atÄ±k yaklaÅŸÄ±mÄ±na uyuyor musunuz?",
      "Plastik ÅŸiÅŸe yerine tekrar kullanÄ±labilir ÅŸiÅŸe kullanÄ±yor musunuz?",
      "KullanÄ±lmÄ±ÅŸ malzemeleri yeniden deÄŸerlendiriyor musunuz?",
      "Geri dÃ¶nÃ¼ÅŸÃ¼m ve sÄ±fÄ±r atÄ±k konularÄ±nda Ã§evrenize farkÄ±ndalÄ±k yaratÄ±yor musunuz?"
    ]
  },
  karbonAyakizi: {
    baslik: "Karbon Ayak Ä°zi",
    sorular: [
      "GÃ¼nlÃ¼k kÄ±sa mesafeleri araÃ§ yerine yÃ¼rÃ¼yerek gidiyor musunuz?",
      "Hafta iÃ§i iÅŸ veya okul iÃ§in toplu taÅŸÄ±ma kullanÄ±yor musunuz?",
      "Bisiklet kullanÄ±yor musunuz?",
      "Ã–zel araÃ§ kullanÄ±mÄ±nÄ±zÄ± azaltmak iÃ§in dikkat ediyor musunuz?",
      "UÃ§ak yolculuÄŸu yaparken alternatifleri deÄŸerlendiriyor musunuz?",
      "AraÃ§ kullanÄ±rken yakÄ±t tasarrufuna dikkat ediyor musunuz?",
      "AraÃ§ paylaÅŸÄ±mÄ± veya carpool yapÄ±yor musunuz?",
      "Elektrikli veya hibrit araÃ§ tercih ediyor musunuz?",
      "Hafta sonlarÄ± uzun mesafeler iÃ§in araÃ§ yerine otobÃ¼s veya tren kullanÄ±yor musunuz?",
      "Karbon salÄ±nÄ±mÄ±nÄ± azaltmak iÃ§in genel farkÄ±ndalÄ±ÄŸa sahip misiniz?"
    ]
  },
   iklimNabzi: {
    baslik: "Ä°klim NabzÄ±",
    sorular: [
      "Ä°klim deÄŸiÅŸikliÄŸi hakkÄ±nda bilgi sahibi misiniz?",
      "Ä°klim deÄŸiÅŸikliÄŸinin etkilerinden endiÅŸe duyuyor musunuz?",
      "KÃ¼resel Ä±sÄ±nma konusunda farkÄ±ndalÄ±ÄŸÄ±nÄ±zÄ± artÄ±rmak iÃ§in Ã§aba harcÄ±yor musunuz?",
      "Enerji ve kaynak kullanÄ±mÄ±nda Ã§evreyi dikkate alÄ±yor musunuz?",
      "Ä°klim deÄŸiÅŸikliÄŸiyle mÃ¼cadele eden kampanyalara katÄ±lÄ±yor musunuz?",
      "GÃ¼nlÃ¼k alÄ±ÅŸkanlÄ±klarÄ±nÄ±zÄ±n iklim Ã¼zerindeki etkilerini gÃ¶z Ã¶nÃ¼nde bulunduruyor musunuz?",
      "Ä°klim deÄŸiÅŸikliÄŸi hakkÄ±nda Ã§evrenizle konuÅŸuyor musunuz?",
      "Sera gazÄ± salÄ±nÄ±mÄ±nÄ± azaltacak davranÄ±ÅŸlar sergiliyor musunuz?",
      "Ä°klim deÄŸiÅŸikliÄŸi konusunda kaygÄ±nÄ±z sizi harekete geÃ§iriyor mu?",
      "KÃ¼resel iklim hedeflerine ulaÅŸmak iÃ§in bireysel olarak katkÄ± saÄŸlÄ±yor musunuz?"
    ]
  }
};

const USER_STORAGE_KEY = 'currentUserData'; 
let currentUser = JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || '{}');

let aktifAnketAdi = null; 

function anketiBaslat(anketAdi) {
    // --- BURADAKÄ° GÄ°RÄ°Å KONTROLÃœNÃœ KALDIRDIK ---
    // ArtÄ±k herkes tÄ±klayÄ±p Ã§Ã¶zebilir.

    document.getElementById("anketListesi").classList.add("hidden");
    document.getElementById("anketAlani").classList.remove("hidden");

    // BaÅŸlÄ±klarÄ± gizle
    const anaBaslik = document.querySelector("#anaBaslik");
    if(anaBaslik) anaBaslik.classList.add("hidden");
    
    const header = document.querySelector(".main-header");
    if(header) header.classList.add("hidden-on-poll");

    const anket = anketler[anketAdi];
    document.getElementById("anketBaslik").innerText = anket.baslik;

    const form = document.getElementById("anketFormu");
    form.innerHTML = "";
    
    aktifAnketAdi = anketAdi; 
    ilerlemeyiSifirla(); 

    anket.sorular.forEach((soru, i) => {
        const soruDiv = document.createElement("div");
        soruDiv.classList.add("soru");
        const soruAdi = `soru${i}`; 

        soruDiv.innerHTML = `
            <p>${i + 1}. ${soru}</p>
            <label><input type="radio" name="${soruAdi}" value="5"> Evet</label>
            <label><input type="radio" name="${soruAdi}" value="3"> Bazen</label>
            <label><input type="radio" name="${soruAdi}" value="1"> HayÄ±r</label>
        `;
        form.appendChild(soruDiv);
    });

    const radioButtons = form.querySelectorAll('input[type="radio"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', () => {
            ilerlemeyiGuncelle(aktifAnketAdi);
        });
    });
}

async function anketiGonder() {
  const sorular = document.querySelectorAll("#anketFormu .soru");
  let toplamPuan = 0;

  sorular.forEach((_, i) => {
    const secilen = document.querySelector(`input[name="soru${i}"]:checked`);
    if (secilen) toplamPuan += parseInt(secilen.value);
  });

  const ortalama = toplamPuan / sorular.length;
  let sonuc = "";
  const baslik = document.getElementById("anketBaslik").innerText;

  if (baslik === "TopraÄŸÄ±n Sesi") {
    if (ortalama >= 4.5) sonuc = "ğŸŒŠ Harika! Su tasarrufuna Ã§ok dikkat ediyorsunuz.";
    else if (ortalama >= 3) sonuc = "ğŸ’§ Fena deÄŸil! Su kullanÄ±mÄ±nda dikkatli olmalÄ±sÄ±nÄ±z.";
    else sonuc = "âš ï¸ Su kullanÄ±m alÄ±ÅŸkanlÄ±klarÄ±nÄ±z kuraklÄ±ÄŸa etki ediyor.";
  } else if (baslik === "Ne kadar Ã§evrecisiniz?") {
    if (ortalama >= 4.5) sonuc = "ğŸŒ¿ Harika! GerÃ§ek bir Ã§evre dostusunuz!";
    else if (ortalama >= 3) sonuc = "ğŸŒ± Fena deÄŸil! Biraz daha dikkatli olabilirsiniz.";
    else sonuc = "âš ï¸ Ã‡evre konusunda daha bilinÃ§li olmalÄ±sÄ±nÄ±z.";
  } else if (baslik === "Patili dostlara bakÄ±ÅŸÄ±mÄ±z") {
    if (ortalama >= 4.5) sonuc = "ğŸ¾ Tebrikler! GerÃ§ek bir hayvanseversiniz!";
    else if (ortalama >= 3) sonuc = "ğŸ¶ Fena deÄŸil! Sevgiyi geliÅŸtirebilirsiniz.";
    else sonuc = "ğŸ± Hayvanlara karÅŸÄ± daha duyarlÄ± olmalÄ±sÄ±nÄ±z.";
  } else if (baslik === "Minimal AtÄ±k, Maximum Etki") {
    if (ortalama >= 4.5) sonuc = "â™»ï¸ Harika! SÄ±fÄ±r atÄ±k konusunda Ã§ok bilinÃ§lisiniz!";
    else if (ortalama >= 3) sonuc = "â™»ï¸ Fena deÄŸil! AlÄ±ÅŸkanlÄ±klarÄ±nÄ±zÄ± geliÅŸtirebilirsiniz.";
    else sonuc = "âš ï¸ SÄ±fÄ±r atÄ±k alÄ±ÅŸkanlÄ±klarÄ±nÄ±z zayÄ±f.";
  } else if (baslik === "Karbon Ayak Ä°zi") {
    if (ortalama >= 4.5) sonuc = "ğŸŒ± Harika! Karbon ayak izinizi minimumda tutuyorsunuz.";
    else if (ortalama >= 3) sonuc = "ğŸš¶â€â™‚ï¸ Fena deÄŸil! Biraz daha azaltabilirsiniz.";
    else sonuc = "âš ï¸ Karbon ayak izinizi ciddi ÅŸekilde azaltmalÄ±sÄ±nÄ±z.";
  } else if (baslik === "Ä°klim NabzÄ±") {
    if (ortalama >= 4.5) sonuc = "ğŸŒ Harika! Ä°klim deÄŸiÅŸikliÄŸi konusunda Ã§ok bilinÃ§lisiniz.";
    else if (ortalama >= 3) sonuc = "ğŸŒ± Fena deÄŸil! FarkÄ±ndalÄ±ÄŸÄ±nÄ±zÄ± artÄ±rabilirsiniz.";
    else sonuc = "âš ï¸ Ä°klim deÄŸiÅŸikliÄŸi hakkÄ±nda daha bilinÃ§li olmanÄ±z gerekiyor.";
  }
 
  document.getElementById("sonucMetni").innerText = sonuc;

  // VERÄ°TABANI Ä°STEÄÄ° (Misafir ise server.js kaydetmeden baÅŸarÄ±lÄ± dÃ¶ner)
  try {
      const userId = (currentUser && currentUser.isLoggedIn) ? currentUser.id : 0;
      
      await fetch('/api/polls/vote', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ user_id: userId, poll_name: baslik, score: toplamPuan })
      });
  } catch(e) { console.error(e); }

  const tekrarBtn = document.getElementById('tekrarBtn');
  if (tekrarBtn) {
      tekrarBtn.classList.remove("hidden");
      tekrarBtn.disabled = false;           
      tekrarBtn.style.opacity = 1;          
  }

  const gonderBtn = document.getElementById("gonderBtn");
  if (gonderBtn) {
      gonderBtn.disabled = true; 
      gonderBtn.style.opacity = 0.5; 
  }
}

function anketleriGoster() {
    document.getElementById("anketListesi").classList.remove("hidden");
    document.getElementById("anketAlani").classList.add("hidden");
    document.getElementById("sonucMetni").innerText = "";

    const anaBaslik = document.querySelector("#anaBaslik");
    if(anaBaslik) anaBaslik.classList.remove("hidden");
    
    const header = document.querySelector(".main-header");
    if(header) header.classList.remove("hidden-on-poll");
    
    ilerlemeyiSifirla(); 
    aktifAnketAdi = null; 
}

function ilerlemeyiGuncelle(anketAdi) {
    const toplamSoruSayisi = anketler[anketAdi].sorular.length;
    const cevaplananSoruSayisi = document.querySelectorAll(`#anketFormu input[type="radio"]:checked`).length;
    const gecerliCevapSayisi = Math.min(cevaplananSoruSayisi, toplamSoruSayisi);
    
    const yuzde = Math.round((gecerliCevapSayisi / toplamSoruSayisi) * 100);
    const gecerliYuzde = Math.min(100, yuzde);

    const progressBar = document.getElementById('anket-progress-bar');
    const progressText = document.getElementById('anket-progress-text');

    if (progressBar && progressText) {
        const red = Math.round(255 * (100 - gecerliYuzde) / 100); 
        const green = Math.round(255 * gecerliYuzde / 100); 
        const blue = 0; 
        const renkKodu = `rgb(${red}, ${green}, ${blue})`;

        progressBar.style.width = gecerliYuzde + '%';
        progressBar.style.backgroundColor = renkKodu;
        progressText.textContent = gecerliYuzde + '% Ä°lerlendi';

        const gonderBtn = document.getElementById('gonderBtn');
        if (gonderBtn) {
            gonderBtn.disabled = gecerliYuzde !== 100;
            gonderBtn.style.opacity = gecerliYuzde === 100 ? 1 : 0.5;
        }
    }
 }

function ilerlemeyiSifirla() {
    const progressBar = document.getElementById('anket-progress-bar');
    const progressText = document.getElementById('anket-progress-text');
    const gonderBtn = document.getElementById('gonderBtn');
    const tekrarBtn = document.getElementById('tekrarBtn');

    if (progressBar && progressText) {
        progressBar.style.width = '0%';
        progressBar.style.backgroundColor = '#ff0000'; 
        progressText.textContent = '0% Ä°lerlendi';
    }
    if (gonderBtn) {
        gonderBtn.disabled = true;
        gonderBtn.style.opacity = 0.5;
    }
    if (tekrarBtn) {
        tekrarBtn.classList.add("hidden"); 
        tekrarBtn.disabled = true;           
    }
}

function anketiTekrarCoz() {
  if (aktifAnketAdi) {
    anketiBaslat(aktifAnketAdi);
    document.getElementById("sonucMetni").innerText = "";
  }
}